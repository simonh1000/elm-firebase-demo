<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="theme-color" content="#0a691f" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1, shrink-to-fit=no"
        />
        <link rel="manifest" href="/manifest.json" />
        <link rel="icon" sizes="192x192" href="images/icons/icon-192x192.png" />
        <link rel="apple-touch-icon" href="images/icons/icon-192x192.png">
        <title>2020 Xmas presents</title>
        <style media="screen">
            body {
                background-color: #ddd;
                margin: 0;
                font-family: sans-serif;
            }
            .app {
                height: 100vh;
                display: flex;
                flex-direction: column;
            }
            header.removable {
                display: flex;
                flex-direction: row;
                align-items: center;
                flex: 0 0 60px;
                background-color: #0a691f;
                color: white;
            }
        </style>
    </head>

    <body>
    <script type="module">
        import {Workbox, messageSW} from 'https://storage.googleapis.com/workbox-cdn/releases/5.1.2/workbox-window.prod.mjs';

        if ('serviceWorker' in navigator) {
            var wb = new Workbox('/service-worker.js');
            let registration;
            console.log("wb", wb);
            setInterval(() => {
               wb.update()
            }, 5000);

            const showSkipWaitingPrompt = (event) => {
                console.log("registration", registration);
                // `event.wasWaitingBeforeRegister` will be false if this is
                // the first time the updated service worker is waiting.
                // When `event.wasWaitingBeforeRegister` is true, a previously
                // updated service worker is still waiting.
                // You may want to customize the UI prompt accordingly.

                // Assumes your app has some sort of prompt UI element
                // that a user can either accept or reject.
                const createUIPrompt = (r => r);
                var prompt = createUIPrompt({
                    onAccept: async () => {
                        console.log("running onAccept");
                        // Assuming the user accepted the update, set up a listener
                        // that will reload the page as soon as the previously waiting
                        // service worker has taken control.
                        wb.addEventListener('controlling', (event) => {
                            console.log("controlling");
                            window.location.reload();
                        });

                        if (registration && registration.waiting) {
                            // Send a message to the waiting service worker,
                            // instructing it to activate.
                            // Note: for this to work, you have to add a message
                            // listener in your service worker. See below.
                            console.log("Sending SKIP_WAITING")
                            messageSW(registration.waiting, {type: 'SKIP_WAITING'});
                        }
                    },

                    onReject: () => {
                        prompt.dismiss();
                    }
                });

                console.log("wasWaitingBeforeRegister", event.wasWaitingBeforeRegister);
                const msg = event.wasWaitingBeforeRegister ? "An existing SW is still waiting to install" : "A new service worker is waiting";
                if (window.confirm(msg)) {
                    prompt.onAccept();
                }
            };

            // Add an event listener to detect when the registered
            // service worker has installed but is waiting to activate.
            wb.addEventListener('waiting', showSkipWaitingPrompt);
            wb.addEventListener('externalwaiting', showSkipWaitingPrompt);

            wb.register().then((r) => registration = r);
        }
    </script>
    <header class="removable">Xmas 2020</header>
        <!-- The core Firebase JS SDK is always required and must be listed first
    Ideally want to add defer to each script tag
     -->
        <script src="https://www.gstatic.com/firebasejs/6.3.5/firebase-app.js"></script>

        <!-- include only the Firebase features as you need -->
        <script src="https://www.gstatic.com/firebasejs/6.3.5/firebase-auth.js"></script>
        <script src="https://www.gstatic.com/firebasejs/6.3.5/firebase-database.js"></script>
        <script src="https://www.gstatic.com/firebasejs/6.3.5/firebase-messaging.js"></script>

        <!-- Initialize Firebase -->
        <!--    <script src="./firebase-init.js"></script>-->
        <!--    <script src="/__/firebase/init.js"></script>-->
    </body>
</html>
